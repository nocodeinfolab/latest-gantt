<!DOCTYPE html>
<html>
<head>
    <title>Dynamic Gantt Chart</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', { packages: ['gantt'] });
        google.charts.setOnLoadCallback(drawChart);

        // Utility: Parse query parameters from the URL
        function getQueryParams() {
            const params = new URLSearchParams(window.location.search);
            return Object.fromEntries(params.entries());
        }

        // Generate Gantt data rows from query parameters
        function parseGanttData(params) {
            const labels = params.labels ? params.labels.split(',') : [];
            const startDates = params.startDates ? params.startDates.split(',') : [];
            const endDates = params.endDates ? params.endDates.split(',') : [];
            const completionStatuses = params.completionStatuses ? params.completionStatuses.split(',') : [];

            // Ensure all parameters are provided and have equal lengths
            if (!labels.length || labels.length !== startDates.length || labels.length !== endDates.length || labels.length !== completionStatuses.length) {
                throw new Error('Mismatched or missing labels, startDates, endDates, or completionStatuses.');
            }

            // Map completion statuses to percentages (for Gantt chart) and text
            const statusToPercent = {
                "Not Started": 0,
                "In Progress": 50,
                "Completed": 100
            };

            // Map completion statuses to colors
            const statusToColor = {
                "Not Started": '#FF0000', // Red
                "In Progress": '#FFFF00', // Yellow
                "Completed": '#008000'    // Green
            };

            // Create rows for the Gantt chart, including original index for sorting later
            const dataRows = labels.map((label, index) => {
                const startDate = new Date(startDates[index]);
                const endDate = new Date(endDates[index]);
                const completionStatus = completionStatuses[index].trim();
                const percentComplete = statusToPercent[completionStatus] !== undefined ? statusToPercent[completionStatus] : 0;
                const color = statusToColor[completionStatus] || '#FFFFFF'; // Default to white if status is unknown

                if (isNaN(startDate) || isNaN(endDate)) {
                    throw new Error(`Invalid date format for task: ${label}`);
                }

                return {
                    index: index,  // Store the original index to maintain the order
                    row: [
                        `Task${index + 1}`,         // Task ID
                        label.trim(),               // Task Name
                        '',                         // Resource (Optional)
                        startDate,                  // Start Date
                        endDate,                    // End Date
                        null,                       // Duration (Auto-calculated)
                        percentComplete,            // Percent Complete (Mapped from status)
                        null,                       // Dependencies (Optional)
                        completionStatus,           // Custom Status Column (Text)
                        color                       // Color Column based on status
                    ]
                };
            });

            // Sort the rows based on the original index to maintain the order
            dataRows.sort((a, b) => a.index - b.index);

            // Return only the row data (sorted)
            return dataRows.map(data => data.row);
        }

        function drawChart() {
            const params = getQueryParams();

            // Validate that required parameters are present
            if (!params.labels || !params.startDates || !params.endDates || !params.completionStatuses) {
                document.getElementById('gantt_chart').innerHTML =
                    'Error: Missing required parameters (labels, startDates, endDates, completionStatuses).';
                return;
            }

            try {
                const data = new google.visualization.DataTable();
                data.addColumn('string', 'Task ID');
                data.addColumn('string', 'Task Name');
                data.addColumn('string', 'Resource');
                data.addColumn('date', 'Start Date');
                data.addColumn('date', 'End Date');
                data.addColumn('number', 'Duration');
                data.addColumn('number', 'Percent Complete');
                data.addColumn('string', 'Dependencies');
                data.addColumn('string', 'Status'); // Custom Status Column for displaying text
                data.addColumn('string', 'Color');  // New column for task color

                // Add rows parsed from query parameters
                const dataRows = parseGanttData(params);
                data.addRows(dataRows);

                // Dynamically calculate chart height
                const chartHeight = Math.max(400, 40 * dataRows.length);

                const options = {
                    height: chartHeight, // Adjust height dynamically
                    gantt: {
                        criticalPathEnabled: true,
                        criticalPathStyle: {
                            stroke: '#e64a19',
                            strokeWidth: 2
                        },
                        // Set a tooltip to show the status text
                        tooltip: { 
                            isHtml: true, 
                            trigger: 'focus' 
                        },
                        // Custom task bar color based on the 'Color' column
                        barHeight: 30
                    }
                };

                const chart = new google.visualization.Gantt(document.getElementById('gantt_chart'));

                // Draw the chart
                chart.draw(data, options);
            } catch (error) {
                document.getElementById('gantt_chart').innerHTML =
                    'Error generating Gantt chart: ' + error.message;
            }
        }
    </script>
</head>
<body>
    <div id="gantt_chart"></div>
</body>
</html>
